(()=>{"use strict";const e=class{constructor(e){this.apiKey=e.apiKey,this.baseURL=e.baseURL,this.chat={completions:{create:this.createChatCompletion.bind(this)}}}async createChatCompletion(e){const r=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:e.model,messages:e.messages,max_tokens:e.max_tokens})});if(!r.ok){const e=await r.json().catch((()=>({error:{message:"API request failed"}})));throw new Error(e.error?.message||"API request failed")}return r.json()}},r="undefined"!=typeof browser?browser:chrome;function t(){if("undefined"!=typeof browser)try{return browser.runtime.getBrowserInfo?"firefox":"chrome"}catch{return"chrome"}return"chrome"}async function o(e){if("firefox"!==t())return chrome.sidePanel.open({tabId:e.id});try{await browser.sidebarAction.open()}catch(e){return console.error("Sidebar error:",e),browser.windows.create({url:"popup.html",type:"popup",width:400,height:600})}}chrome.runtime.onMessage.addListener(((t,o,s)=>{if("sendToAPI"===t.action)return async function(t){try{const o=await r.storage.sync.get(["apiUrl","apiToken","modelName","maxTokens"]);if(!o.apiUrl)throw new Error("API URL is not configured. Please open settings and configure the API URL.");if(!t.trim())throw new Error("Please enter some text to process.");const s=new e({apiKey:o.apiToken,baseURL:o.apiUrl}),a=await s.chat.completions.create({model:o.modelName||"meta-llama/Llama-2-7b-chat",messages:[{role:"user",content:t}],max_tokens:parseInt(o.maxTokens)||500});if(!a.choices?.[0]?.message)throw new Error("Invalid response from API. Please check your settings and try again.");return{success:!0,message:a.choices[0].message.content.trim()}}catch(e){return{success:!1,error:e.message}}}(t.content).then((e=>{s(e)})).catch((e=>{s({success:!1,error:e.message||"API request failed"})})),!0})),chrome.storage.onChanged.addListener(((e,r)=>{"sync"===r&&chrome.tabs.query({},(r=>{r.forEach((r=>{try{chrome.tabs.sendMessage(r.id,{action:"settingsUpdated",changes:e})}catch(e){console.debug("Could not send to tab:",r.id)}}))}))})),r.action.onClicked.addListener((async e=>{if(!e.url.startsWith("chrome://")&&!e.url.startsWith("about:"))try{await o(e)}catch(e){console.error("Failed to open panel:",e),r.windows.create({url:"popup.html",type:"popup",width:400,height:600})}})),"firefox"===t()?browser.browserAction.onClicked.addListener((async e=>{await async function(){if("firefox"===t())try{await browser.sidebarAction.open()}catch(e){throw console.error("Toggle sidebar error:",e),e}}().catch((e=>{console.error("Failed to toggle sidebar:",e),browser.windows.create({url:"popup.html",type:"popup",width:400,height:600})}))})):chrome.action.onClicked.addListener((async e=>{e.url.startsWith("chrome://")||e.url.startsWith("about:")||await o(e)})),"firefox"===t()&&browser.runtime.onInstalled.addListener((()=>{browser.sidebarAction.open()}))})();