(()=>{"use strict";const e=class{constructor(e){this.apiKey=e.apiKey,this.baseURL=e.baseURL,this.chat={completions:{create:this.createChatCompletion.bind(this)}}}async createChatCompletion(e){const t=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:e.model,messages:e.messages,max_tokens:e.max_tokens})});if(!t.ok){const e=await t.json().catch((()=>({error:{message:"API request failed"}})));throw new Error(e.error?.message||"API request failed")}return t.json()}},t="undefined"!=typeof browser?browser:chrome;chrome.runtime.onMessage.addListener(((s,o,r)=>{if("sendToAPI"===s.action)return async function(s){try{const o=await t.storage.sync.get(["apiUrl","apiToken","modelName","maxTokens"]);if(!o.apiUrl)throw new Error("API URL is not configured. Please open settings and configure the API URL.");if(!s.trim())throw new Error("Please enter some text to process.");const r=new e({apiKey:o.apiToken,baseURL:o.apiUrl}),a=await r.chat.completions.create({model:o.modelName||"meta-llama/Llama-2-7b-chat",messages:[{role:"user",content:s}],max_tokens:parseInt(o.maxTokens)||500});if(!a.choices?.[0]?.message)throw new Error("Invalid response from API. Please check your settings and try again.");return{success:!0,message:a.choices[0].message.content.trim()}}catch(e){return{success:!1,error:e.message}}}(s.content).then((e=>{r(e)})).catch((e=>{r({success:!1,error:e.message||"API request failed"})})),!0})),chrome.storage.onChanged.addListener(((e,t)=>{"sync"===t&&chrome.tabs.query({},(t=>{t.forEach((t=>{try{chrome.tabs.sendMessage(t.id,{action:"settingsUpdated",changes:e})}catch(e){console.debug("Could not send to tab:",t.id)}}))}))})),t.action.onClicked.addListener((async e=>{if(!e.url.startsWith("chrome://")&&!e.url.startsWith("about:"))try{await async function(e){return"firefox"==("undefined"!=typeof browser?"firefox":"chrome")?browser.windows.create({url:"popup.html",type:"popup",width:400,height:600}):chrome.sidePanel.open({tabId:e.id})}(e)}catch(e){console.error("Failed to open panel:",e),t.windows.create({url:"popup.html",type:"popup",width:400,height:600})}}))})();