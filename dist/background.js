(()=>{"use strict";const e=class{constructor(e){this.apiKey=e.apiKey,this.baseURL=e.baseURL,this.chat={completions:{create:this.createChatCompletion.bind(this)}}}async createChatCompletion(e){const t=await fetch(`${this.baseURL}/v1/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:e.model,messages:e.messages,max_tokens:e.max_tokens})});if(!t.ok){const e=await t.json().catch((()=>({error:{message:"API request failed"}})));throw new Error(e.error?.message||"API request failed")}return t.json()}};chrome.runtime.onMessage.addListener(((t,s,a)=>{if("sendToAPI"===t.action)return async function(t){try{const s=await chrome.storage.sync.get(["apiUrl","apiToken","modelName","maxTokens"]);if(!s.apiUrl)throw new Error("API URL is not configured. Please open settings and configure the API URL.");if(!t.trim())throw new Error("Please enter some text to process.");const a=new e({apiKey:s.apiToken,baseURL:s.apiUrl}),o=await a.chat.completions.create({model:s.modelName||"meta-llama/Llama-2-7b-chat",messages:[{role:"user",content:t}],max_tokens:parseInt(s.maxTokens)||500});if(!o.choices?.[0]?.message)throw new Error("Invalid response from API. Please check your settings and try again.");return{success:!0,message:o.choices[0].message.content.trim()}}catch(e){return{success:!1,error:e.message}}}(t.content).then((e=>{a(e)})).catch((e=>{a({success:!1,error:e.message||"API request failed"})})),!0})),chrome.storage.onChanged.addListener(((e,t)=>{"sync"===t&&chrome.tabs.query({},(t=>{t.forEach((t=>{try{chrome.tabs.sendMessage(t.id,{action:"settingsUpdated",changes:e})}catch(e){console.debug("Could not send to tab:",t.id)}}))}))})),chrome.action.onClicked.addListener((async e=>{if(!e.url.startsWith("chrome://"))try{await chrome.sidePanel.open({tabId:e.id})}catch(e){console.error("Failed to open side panel:",e),chrome.windows.create({url:"popup.html",type:"popup",width:400,height:600})}}))})();